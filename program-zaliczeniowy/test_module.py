from specialcurve import secp128r1, secp256k1, brainpoolp384r1, p521
from elliptic import ellipticcurve, point
from utils import bisprime, legendre, tonelli, hasmodularsqrt, modularsqrt
import pytest
import os

ec1 = ellipticcurve(12344008895446582123, 8790560059401314605, 16337521985370093323)
ec2 = ellipticcurve(3717225048, 3166956939, 3804818429)
ec3 = ellipticcurve(1, 6, 31)

signingcurves = [secp128r1, secp256k1, brainpoolp384r1, p521]
simplecurves = [ec1, ec2, ec3]
curves = signingcurves + simplecurves

def test_bisprime():
	assert bisprime(17)
	assert bisprime(115792089237316195423570985008687907853269984665640564039457584007908834671663)
	assert bisprime(57896044618658097711785492504343953926634992332820282019728792003956564819949)
	assert not bisprime(10)
	assert not bisprime(146869579454129274021598652743611211589)

def test_legendre():
	p = 256580600396254200892099953241962131461
	assert bisprime(p)
	assert legendre(110790947993323365676220254416489963426, p) == 1
	assert legendre(223047169949258274488188987102130547027, p) == p - 1
	assert legendre(1167709257, 3702914297) == 1
	
def test_modularsqrt():
	p = p521.order
	target = 45624247365591046796310041675907369391184212803484856166714064349670306038163982279408911259821595952416211533094449768576012107343608066789050129949259867
	sol = modularsqrt(target, p)
	assert sol[0] ** 2 % p == target and sol[1] ** 2 % p == target
	p2 = 95517253267452115525119223892285144247446518137158873913654047894466508919483
	target2 = 29464334443770099564970521399257255624711298756564959040296832064179421853571
	sol2 = modularsqrt(target2, p2)
	assert sol2[0] ** 2 % p2 == target2 and sol2[1] ** 2 % p2 == target2
	p3 = 326171747057304072185886048885491652157
	target3 = 246706196330972956588303980766644374364
	sol3 = modularsqrt(target3, p3)
	assert sol3[0] ** 2 % p3 == target3 and sol3[1] ** 2 % p3 == target3
	p4 = 79163559823803627129670698067898902647952647712069081650938690983686082136401
	target4 = 38745334488282378710006558866622939927791103699890083772996817447390425750924
	sol4 = tonelli(target4, p4)
	assert sol4[0] ** 2 % p4 == target4 and sol4[1] ** 2 % p4 == target4

def test_pneg():
	assert ec1.pneg(point(2266230753450742922, 7339119121187954968)) == point(2266230753450742922, 8998402864182138355)
	assert ec2.pneg(point(3048371062, 2324578145)) == point(3048371062, 1480240284)
	assert ec3.pneg(point(30, 2)) == point(30, 29)

def test_pdbl():
	assert ec1.pdbl(point(2266230753450742922, 7339119121187954968)) == (14297305230156868154, 9116788816790473349)
	assert ec2.pdbl(point(3048371062, 2324578145)) == (274455779, 758872938)
	assert ec3.pdbl(point(30, 2)) == (3, 25)

def test_pointadd():
	assert ec1.pointadd(point(2266230753450742922, 7339119121187954968), point(10340618518996224558, 5389945835395485357)) == point(8967446278303328698, 15615398304861916223)
	assert ec2.pointadd(point(3048371062, 2324578145), point(169051456, 2136068669)) == point(1377226254, 1896658349)
	assert ec3.pointadd(point(30, 2), point(1, 15)) == point(19, 23)

def test_pointsub():
	assert ec1.pointsub(point(8967446278303328698, 15615398304861916223), point(10340618518996224558, 5389945835395485357)) == point(2266230753450742922, 7339119121187954968)
	assert ec2.pointsub(point(1377226254, 1896658349), point(3048371062, 2324578145)) == point(169051456, 2136068669)
	assert ec3.pointsub(point(19, 23), point(1, 15)) == point(30, 2)

def test_pointmul():
	assert ec1.pointmul(point(8967446278303328698, 15615398304861916223), 21360686697563) == (5399710437529484048, 12901026443141152542)
	assert ec2.pointmul(point(3048371062, 2324578145), 5674342321) == (1195538995, 1625375525)
	assert ec3.pointmul(point(2, 4), 13) == (30, 29)

def test_recovery():
	recpoints = brainpoolp384r1.recovery(20053536536808461696029824539388600812320142201273144258884407381479846193692169875516509511514310578699697269072935)
	assert point(20053536536808461696029824539388600812320142201273144258884407381479846193692169875516509511514310578699697269072935, 2425550674498929191401874846566827519604446312834200455524641768789156282889885209742691526463476079491592707549006) in recpoints
	assert point(20053536536808461696029824539388600812320142201273144258884407381479846193692169875516509511514310578699697269072935, 19233720095620386981667361995765777460191670074183448144556976735031933651136076612493870456381058008949115710424325) in recpoints
	recpoints2 = ec1.recovery(9482618335363908712)
	assert point(9482618335363908712, 9957182643325125942) in recpoints2
	assert point(9482618335363908712, 6380339342044967381) in recpoints2
	recpoints3 = secp128r1.recovery(280591116568139248265394894053152387854)
	assert point(280591116568139248265394894053152387854, 130251516869663049992028517342926016454) in recpoints3
	assert point(280591116568139248265394894053152387854, 210030849892819088442817414901754294329) in recpoints3

def test_randpoint():
	for ec in curves:
		for i in range(5):
			pt = ec.randpoint()
			assert ec.bisoncurve(pt)

def test_signing():
	# Testuje funkcje zwiazane z podpisami cyfrowymi: getkeypair, sign, verify, recoverpub
	for ec in signingcurves:
		for i in range(5):
			priv, pub = ec.getkeypair()
			msg = os.urandom(32) # losowa wiadomosc do podpisania
			# Domyslnie uzywam funkcji hashujacej sha256 do podpisow
			sig = ec.sign(priv, msg)
			assert ec.verify(pub, msg, sig)
			# Odzyskiwanie klucza publicznego z podpisu cyfrowego
			# Funkcja zwraca dwa klucze publiczne poprawnie weryfikujace pare (wiadomosc + podpis) jeden z nich musi byc taki sam jak pub
			recpubs = ec.recoverpub(msg, sig)
			assert pub == recpubs[0] or pub == recpubs[1]

if __name__ == "__main__":
	pytest.main()
	print ("Wszystkie testy przebiegly pomyslnie")